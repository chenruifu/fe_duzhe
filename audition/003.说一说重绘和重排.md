重排(reflow)和重绘(repaint)

## 页面生成的过程

1. HTML 被 HTML 解析器解析成 DOM 树
2. CSS 被 CSS 解析器解析成 CSSOM 树
3. 结合 DOM 树和 CSSOM 树，生成一棵渲染树(Render Tree)，这一过程称为 Attachment
4. 生成布局(flow)，浏览器在屏幕上”画”出渲染树中的所有节点
5. 将布局绘制(paint)在屏幕上，显示出整个页面。

第4步和第5步是最耗时的部分，这两步合起来，就是我们通常所说的渲染。

## 重排(回流/reflow)

当DOM的变化影响了元素的几何信息(元素的的位置和尺寸大小)，浏览器需要重新计算元素的几何属性，将其安放在界面中的正确位置，这个过程叫做重排。

重排也叫回流，简单的说就是重新生成布局，重新排列元素。

每个页面至少需要一次重排，就是在页面第一次加载的时候。

下面的情况会发生重排：

- 页面初始渲染，这是开销最大的一次重排
- 添加/删除可见的DOM元素
- 改变元素位置
- 改变元素尺寸，比如边距、填充、边框、宽度和高度等
- 改变元素内容，比如文字数量，图片大小等
- 改变元素字体大小
- 改变浏览器窗口尺寸，比如resize事件发生时
- 查询某些属性或调用某些计算方法：offsetWidth、offsetHeight等

## 重绘(repaint)

当一个元素的外观发生改变，但没有改变布局，重新把元素外观绘制出来的过程，叫做重绘。比如设置：color、background-color 等属性。

重绘和重排的关系：在重排的时候，浏览器会使渲染树中受到影响的部分失效，并重新构造这部分渲染树，完成重排后，浏览器会重新绘制受影响的部分到屏幕中，该过程称为重绘。所以，重排必定会引发重绘，但重绘不一定会引发重排。

## 优化手段

因为重排的代价是比较高的，会破坏用户体验，让UI展示变得迟缓。所以在交互逻辑中，应该尽可能的减少**重排范围**和**重排次数**。

减少重排范围

- 少用table布局，table 及其内部元素可能需要多次计算才能确定好其在渲染树中节点的属性值，比同等元素要多花两倍时间
- 尽可能在小范围固定节点上操作，减少对兄弟节点的影响，比如：把一个DOM元素的宽高之类的几何信息定死，然后再DOM内部操作触发重排，这只会重新渲染当前DOM内部的元素，不会影响到外界的元素。

减少重排次数

- 集中样式改变，不要一条条的样式改变操作
- 分离读写操作，查询某些计算方法会触发重排的，读写应该分开
- 将 DOM 离线，不在当前的 DOM 树做修改，可以剥离出来，进行一系列操作之后，再装载入对应 DOM 树。